"""
Unit tests for WeatherExtractor
Tests validate extraction and transformation against provided examples.
"""
import pytest
from unittest.mock import AsyncMock, patch, Mock
import aiohttp
from extractor import WeatherExtractor, IDataExtractor
from models import WeatherInputSchema, WeatherOutputSchema
@pytest.fixture
def config():
    """Create test configuration."""
    return {
        "api_key": "test_api_key_12345",
        "cache_ttl": 1800,
        "timeout": 10,
        "max_retries": 3
    }
@pytest.fixture
def mock_logger():
    """Create mock logger."""
    logger = Mock()
    logger.info = Mock()
    logger.error = Mock()
    logger.warning = Mock()
    return logger
@pytest.fixture
def extractor(config, mock_logger):
    """Create extractor instance for testing."""
    return WeatherExtractor(config=config, logger=mock_logger)
@pytest.fixture
def example_1_input():
    """Example 1: London rainy weather."""
    return {
        "coord": {"lon": -0.1257, "lat": 51.5085},
        "weather": [{"id": 500, "main": "Rain", "description": "light rain", "icon": "10d"}],
        "base": "stations",
        "main": {
            "temp": 15.5,
            "feels_like": 14.2,
            "temp_min": 14.0,
            "temp_max": 17.0,
            "pressure": 1012,
            "humidity": 72
        },
        "visibility": 10000,
        "wind": {"speed": 4.1, "deg": 230},
        "clouds": {"all": 75},
        "dt": 1701360000,
        "sys": {
            "type": 2,
            "id": 2019646,
            "country": "GB",
            "sunrise": 1701331200,
            "sunset": 1701362400
        },
        "timezone": 0,
        "id": 2643743,
        "name": "London",
        "cod": 200
    }
@pytest.fixture
def example_1_output():
    """Expected output for example 1."""
    return {
        "city": "London",
        "country": "GB",
        "temperature_c": 15.5,
        "feels_like_c": 14.2,
        "humidity_percent": 72,
        "pressure_hpa": 1012,
        "wind_speed_ms": 4.1,
        "conditions": "light rain",
        "cloudiness_percent": 75,
        "visibility_m": 10000
    }
@pytest.mark.asyncio
async def test_extract_example_1(extractor, example_1_input, example_1_output):
    """Test extraction matches example 1 (London rainy weather).
    This test validates that the extractor correctly transforms
    the input from example 1 to the expected output.
    """
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.return_value = example_1_input
        result = await extractor.extract(city="London")
        assert result is not None
        assert result["city"] == example_1_output["city"]
        assert result["country"] == example_1_output["country"]
        assert result["temperature_c"] == example_1_output["temperature_c"]
        assert result["feels_like_c"] == example_1_output["feels_like_c"]
        assert result["humidity_percent"] == example_1_output["humidity_percent"]
        assert result["pressure_hpa"] == example_1_output["pressure_hpa"]
        assert result["wind_speed_ms"] == example_1_output["wind_speed_ms"]
        assert result["conditions"] == example_1_output["conditions"]
        assert result["cloudiness_percent"] == example_1_output["cloudiness_percent"]
        assert result["visibility_m"] == example_1_output["visibility_m"]
@pytest.mark.asyncio
async def test_extract_example_2_tokyo(extractor):
    """Test extraction for Tokyo clear weather."""
    input_data = {
        "coord": {"lon": 139.6917, "lat": 35.6895},
        "weather": [{"id": 800, "main": "Clear", "description": "clear sky", "icon": "01d"}],
        "base": "stations",
        "main": {
            "temp": 18.2,
            "feels_like": 17.5,
            "temp_min": 16.0,
            "temp_max": 20.0,
            "pressure": 1015,
            "humidity": 55
        },
        "visibility": 10000,
        "wind": {"speed": 2.5, "deg": 180},
        "clouds": {"all": 0},
        "dt": 1701360000,
        "sys": {"type": 1, "id": 8074, "country": "JP", "sunrise": 1701295200, "sunset": 1701331200},
        "timezone": 32400,
        "id": 1850144,
        "name": "Tokyo",
        "cod": 200
    }
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.return_value = input_data
        result = await extractor.extract(city="Tokyo")
        assert result is not None
        assert result["city"] == "Tokyo"
        assert result["country"] == "JP"
        assert result["temperature_c"] == 18.2
        assert result["conditions"] == "clear sky"
        assert result["cloudiness_percent"] == 0
@pytest.mark.asyncio
async def test_extract_example_3_moscow_snow(extractor):
    """Test extraction for Moscow snowy weather with negative temperature."""
    input_data = {
        "coord": {"lon": 37.6156, "lat": 55.7522},
        "weather": [{"id": 601, "main": "Snow", "description": "snow", "icon": "13d"}],
        "base": "stations",
        "main": {
            "temp": -8.0,
            "feels_like": -12.5,
            "temp_min": -10.0,
            "temp_max": -6.0,
            "pressure": 1020,
            "humidity": 85
        },
        "visibility": 5000,
        "wind": {"speed": 5.5, "deg": 320},
        "clouds": {"all": 90},
        "dt": 1701360000,
        "sys": {"type": 1, "id": 9029, "country": "RU", "sunrise": 1701323400, "sunset": 1701349800},
        "timezone": 10800,
        "id": 524901,
        "name": "Moscow",
        "cod": 200
    }
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.return_value = input_data
        result = await extractor.extract(city="Moscow")
        assert result is not None
        assert result["city"] == "Moscow"
        assert result["temperature_c"] == -8.0
        assert result["feels_like_c"] == -12.5
        assert result["conditions"] == "snow"
        assert result["visibility_m"] == 5000
@pytest.mark.asyncio
async def test_extract_example_4_dubai_hot(extractor):
    """Test extraction for Dubai hot weather."""
    input_data = {
        "coord": {"lon": 55.3047, "lat": 25.2582},
        "weather": [{"id": 800, "main": "Clear", "description": "clear sky", "icon": "01d"}],
        "base": "stations",
        "main": {
            "temp": 35.0,
            "feels_like": 38.5,
            "temp_min": 33.0,
            "temp_max": 37.0,
            "pressure": 1010,
            "humidity": 25
        },
        "visibility": 10000,
        "wind": {"speed": 3.5, "deg": 90},
        "clouds": {"all": 0},
        "dt": 1701360000,
        "sys": {"type": 1, "id": 7537, "country": "AE", "sunrise": 1701314400, "sunset": 1701350400},
        "timezone": 14400,
        "id": 292223,
        "name": "Dubai",
        "cod": 200
    }
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.return_value = input_data
        result = await extractor.extract(city="Dubai")
        assert result is not None
        assert result["temperature_c"] == 35.0
        assert result["humidity_percent"] == 25
@pytest.mark.asyncio
async def test_cache_functionality(extractor, example_1_input):
    """Test that caching works correctly."""
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.return_value = example_1_input
        result1 = await extractor.extract(city="London")
        assert mock_fetch.call_count == 1
        result2 = await extractor.extract(city="London")
        assert mock_fetch.call_count == 1  # Still 1, not called again
        assert result1 == result2
@pytest.mark.asyncio
async def test_error_handling_network_failure(extractor):
    """Test error handling for network failures."""
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.side_effect = aiohttp.ClientError("Network error")
        result = await extractor.extract(city="London")
        assert result is None
@pytest.mark.asyncio
async def test_error_handling_missing_city(extractor):
    """Test error handling when city parameter is missing."""
    result = await extractor.extract()
    assert result is None
@pytest.mark.asyncio
async def test_validation_error_invalid_temperature(extractor):
    """Test handling of invalid temperature data."""
    invalid_data = {
        "coord": {"lon": -0.1257, "lat": 51.5085},
        "weather": [{"description": "test"}],
        "main": {
            "temp": 999.0,  # Invalid temperature
            "feels_like": 14.2,
            "pressure": 1012,
            "humidity": 72
        },
        "visibility": 10000,
        "wind": {"speed": 4.1},
        "clouds": {"all": 75},
        "sys": {"country": "GB"},
        "name": "London"
    }
    with patch.object(extractor, '_fetch_from_api', new_callable=AsyncMock) as mock_fetch:
        mock_fetch.return_value = invalid_data
        result = await extractor.extract(city="London")
        assert result is None
@pytest.mark.asyncio
async def test_nested_field_extraction(extractor):
    """Test nested field extraction helper method."""
    data = {
        "main": {"temp": 15.5},
        "sys": {"country": "GB"},
        "weather": [{"description": "rain"}]
    }
    assert extractor._extract_nested_field(data, "main.temp") == 15.5
    assert extractor._extract_nested_field(data, "sys.country") == "GB"
    assert extractor._extract_nested_field(data, "weather[0].description") == "rain"
    assert extractor._extract_nested_field(data, "missing.field") is None
@pytest.mark.asyncio
async def test_implements_interface(extractor):
    """Test that WeatherExtractor implements IDataExtractor interface."""
    assert isinstance(extractor, IDataExtractor)
    assert hasattr(extractor, 'extract')
    assert callable(extractor.extract)
def test_input_schema_validation():
    """Test WeatherInputSchema validation."""
    valid_data = {
        "coord": {"lon": -0.1257, "lat": 51.5085},
        "weather": [{"description": "rain"}],
        "main": {"temp": 15.5, "humidity": 72},
        "visibility": 10000,
        "wind": {"speed": 4.1},
        "clouds": {"all": 75},
        "sys": {"country": "GB"},
        "name": "London"
    }
    schema = WeatherInputSchema(**valid_data)
    assert schema.name == "London"
    assert schema.main["temp"] == 15.5
def test_output_schema_validation():
    """Test WeatherOutputSchema validation."""